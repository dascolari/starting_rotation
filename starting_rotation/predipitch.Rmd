---
title: "Predi-Pitch: Snack on This Curve Whenever You Want"
author: "David Scolari, Harrison Snell, Brandon Williams"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(here)
path <- here()

source(file.path(path, 'code', 'dugout.R'))

load(file = file.path(path, 'output', 'tables', "overall_performance_all.RDs"))


foreach(id = 1:30) %do% {
  # make filenames according to loop index
  fname_type <- paste0("types", id, ".RDs")
  fname_zones <- paste0("zones", id, ".RDs")
  fname_bypitch <- paste0("by_pitch_performance", id, ".RDs")

  # load table outputs according to loop index
  load(file = file.path(path, 'output', 'tables', fname_type))
  load(file = file.path(path, 'output', 'tables', fname_zones))
  load(file = file.path(path, 'output', 'tables', fname_bypitch))
}

knit_print.data.frame <- lemon_print
load(file.path(path, "output", "pitches_import.RData"))

```

## Introduction
Hitting a baseball has been shown to be one of the most difficult tasks in all of sports. Anybody who has gone to a batting cage and tried the fastest machine for fun knows how hard it can be to hit a normal fastball. That does not even include the possibilities of breaking balls and off-speed pitches. Batters have a fraction of a fraction of a second to recognize a pitch, determine if that pitch will be a ball or a strike, and set their swing into motion. Considering the human body can only move so fast to get the bat over the plate, the batter has to make their decision moments after the ball leaves the pitcher's hand. To give themselves the best chance of making good contact, professional baseball players will often attempt to predict whether a changeup, fastball, or a curveball is coming before the ball leaves the pitcher's hand.

Hitters will use a variety of information to inform their prediction of an upcoming pitch, including scouting reports that teams build coming into a game, situational context, memory of the previous few pitches, and game specific tendencies of a pitcher. In this project, we attempt to model this decision making process with a random forest pitch type classifier. We use pitch level data from the 2015-2018 seasons to predict pitch types for 30 different pitchers who played during that type period. 

Our model aims contributes to the baseball world in the following ways. First, by testing how different sets of features perform at classifying out of sample pitch types, we see that some features are more important for certain pitchers than they are for others. This will help teams focus on the important information when building scouting reports going into a game against a certain pitcher. 

Second, we aim to make the results of our pitch type predictor accessible to baseball fans in hopes that it can augment their viewing experience. For many enthusiasts, strategizing along side the players from pitch to pitch, guessing both what the pitcher is going to throw as well as what the batter's strategy will be, is the most enjoyable part of the game. However, among more casual fans, baseball has the reputation for being "boring" to watch, largely due to the pauses between every pitch, during which players sometimes take 30 or more seconds to relay signs and perform ritualistic jersey adjustments, bat taps, and other manor of baseball superstition. To make this aspect of baseball more palatable to fans, we built an R Shiny web application that allows them to input game situations and call our model's pitch type predictions in real time, allowing them to take part in the "game within the game" of baseball. 

This report proceeds as follows. First we analyze the physical attributes of the pitches that our 30 selected pitchers throw, making the case that it is indeed in the batters best interest to have an idea of how a particular pitch is going to move once it leave the pitcher's hand. Second, we show some evidence that pitchers do adopt different strategies for different game situations. We then describe the rich, pitch level data set we use for this analysis. Finally, we discuss our random forest classifier and the results it produces. 

## Why do we care about a pitch?

Not all pitches are made the same. From sliders to cutters to knuckleballs, each pitch tends to have its own characteristics that define it. 

```{r caption = "Averages of Different Pitch Characteristics", render=lemon_print}

pitch_sum = pitches %>%
  filter(pitch_type != "") %>%
  filter(pitch_type != "IN")%>%
  dplyr::select(pitch_type,px,pz,start_speed,end_speed,spin_rate,spin_dir,break_angle,break_length,break_y)%>%
  mutate(pitch_type = as.factor(pitch_type))%>%
  group_by(pitch_type)%>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))

pitch_sum = pitch_sum %>%
  mutate_if(is.numeric,round, digits=3)

pitch_sum

```

From the table, we essentially see the obvious that is pitches are different. On average we find that fastballs start at almost 94 mph and changeups start at 86 mph. The average break length of a fastball is about 4 inches, which is not too bad, the point that a batter sees a fastball leave the pitcher's hand will most likely cross following a straight line. Compare that to a curveball with almost 13 inches of break and we start to see why knowing the next pitch can be helpful.


```{r}

plot_data = pitches %>%
  filter(pitch_type != "") %>%
  filter(pitch_type != "IN")%>%
  filter(pitch_type != "UN")%>%
  filter(pitch_type != "FA")%>%
  dplyr::select(pitcher_id,pitch_type,px,pz,start_speed,end_speed,spin_rate,spin_dir,break_angle,break_length,break_y)

plot_data$pitch_type = as.factor(plot_data$pitch_type)

plot_archer = plot_data%>%
  filter(pitcher_id == 502042)


ggplot(plot_archer)+
  geom_point(aes(x=spin_rate,y=spin_dir,color=pitch_type),alpha=.2)+
  ggtitle("Spin Rate and Direction for Chris Archer's Pitches")

ggplot(plot_archer)+
  geom_point(aes(x=break_angle,y=break_length,color=pitch_type),alpha=.2)+
  ggtitle("Break Angle and Length for Chris Archer's Pitches")

```

The plots of Chris Archer's pitches give us a glimpse of where one type of pitch becomes another. For Archer, we see that his slider tends to have a relatively low spin rate, with his fastballs having higher spin rates and his changeups in between. As we would expect, Archer's fastballs have little break. His slider however, has a large but variable amount of break and always tends to break in the same direction. These visuals help us understand where a pitch may be going. If we can predict the next pitch is a slider, then we can start to understand the direction and magnitude of break in the pitch. 



```{r}

ggplot(plot_data)+
  geom_density(aes(x=start_speed), fill="blue")+
  ggtitle("Distribution of Start Speeds across Pitches")+
  facet_wrap(~pitch_type)

ggplot(plot_data)+
  geom_density(aes(x=break_length), fill="red")+
  ggtitle("Distribution of Break Length across Pitches")+
  facet_wrap(~pitch_type)
```

Mostly as an exposition into our data, we found the graphs of distributions of break length and start speed to be interesting. They provide a more throrough comparison of pitch types because every pitcher is slightly different. Some pitchers may have a lot more movement on their sinker than others. Similarly, Aroldis Chapman throwing 105 mph fastballs is certainly not the norm in the league. Getting to see the variability of break length and speeds begins to paint the picture of why some pitchers are better than others. 


## Pichers be sequencing
```{r}

load(file = file.path(path, 'output', 'tables', 'kershaw_sequence.RData'))
pitch_sequence

```

```{r}

just_walked

```

## The Data
The data involved in this project consists of every pitch from the 2015 through the 2018 Major League Baseball (MLB) seasons. These four seasons contained nearly 3 million observations, and the data include categorization of 16 different types of pitches, the spin, speed, and location of each pitch, the game situation (score, runners on base, balls and strikes, etc.), information about the pitcher and batter, and the result of the at-bat. 

From this data set, we engineer a few important features. Since each pitch is identified by an at bat id and a pitch number, we can add the previous pitch types as features to each pitch. For this model, we add categorical features for the previous two pitches. We also add the previous at bat's result as a feature.

Although information on each batter might be helpful for this modeling problem, we did not have easy access to this kind of hitter data. As an alternative, we add a factor variable indicating the position in the batting order the pitcher is facing. A team's best hitters tend to bat 3rd or 4th in the order, and a team's worst hitter tends to bat 8th and 9th, so batting order may be able to tell our model a lot about what pitch types a pitcher will throw. 

Lastly, we add features for the game specific share of a pitcher's total pitches that each pitch types makes up. This set of features is meant to capture the fact that a pitcher's arsenal of pitch types may change from game to game. Most games a pitcher might throw mostly four seam fastballs, but there might be game specific "fixed effects" that lead him to rely more on his secondary pitches. We'd like our model to be able to use this information in making its predictions.

## Methodology

Given how difficult it is to get hits consistently at the major league level, having an idea an idea of what the opposing pitcher is about to throw would confer a significant advantage to the hitter. We endeavor to create a model that successfully predicts the next pitch a pitcher will throw in an at-bat, given the circumstances of the at-bat, the tendencies of the pitcher, and the progress of the game up to that point. Using three distinct random forest models, we derive a predictive approach that generally outperforms guessing that the pitcher will throw their most common pitch (often called "sitting on a pitch"), and in most cases, significantly exceeds this "sitting on a pitch" approach.

The models are generated with a train/test split and then evaluated for the out-of-sample performance against the testing set. Models are generated per pitcher, in such a way that be beneficial in application to a baseball manager or hitter, given the situation in the game. 

### Our Random Forests

Random forests, much like actual forests, are an aggregation of individual trees. Tree models make predictions through a series of binary decisions based on a selection of features that sort the data into groups of most likely outcomes. While trees are intuitive, a well performing model will add some layers of complexity that reduce over fitting. Bootstrap aggregating, or "bagging" involves taking $B$ bootstrapped samples of the original data and fitting a tree model to each one. Predictions are generated using a summary of the $B$ tree models. For a categorical outcome, each tree model contributes one vote and the outcome is classified by majority rule. 

Random forests extend bagged trees by only allowing each individual tree to use $m$ of the total number of features, $p$. So bagging is equivalent to a random forest with $m = p$. Restricting the each tree to a subset of the total features decorrelates the individual tree models, reducing variance in the predictions and making it less likely that the model will over fit the data. For our random forest models, we use a common choice of feature size, $m \approx \sqrt p$.

#### The Situational Model

The first of our three random forest models uses information readily available in the at-bat to predict the upcoming pitch. The features involved here include the ball-strike count, opposing batter's stance, inning, how many pitches thrown in the at-bat so far, the game score, and the runners on base. This is the most interpretable model, as it is composed of the factors that are generally considered most relevant and well-known by players and coaches in the moment. As random forests are an aggregation of individual trees, it can be illustrative to look at a single tree to get a sense for how decisions are being made at various nodes. Consider, for example, the following tree as an example of what the random forest is doing for pitcher Felix Hernandez. 

```{r}

## Load in data
set.seed(117) #set seed for image replication 

load(file.path(path, "output", "pitches_import.RData"))

## Felix Hernandez Example ID 2

id = 2

fname_pitcher <- paste0("pitcher", id, ".Rds")
load(file = file.path(path, 'output', 'pitchers', fname_pitcher))

fname_factor <- paste0("pitcher_factor", id, ".RDs")
load(file = file.path(path, 'output', 'pitchers', fname_factor))

pitcher_first <- names$first_name[id]
pitcher_last <- names$last_name[id]

## Train / Test

pitcher_split =  initial_split(pitcher, prop=0.8)
pitcher_train = training(pitcher_split)
pitcher_test  = testing(pitcher_split)

## Single tree and 1SE Prune

pitcher.tree = rpart(pitch_type ~ 
                       inning + 
                       b_count + 
                       s_count +
                       pitch_num +
                       stand +
                       on_1b + 
                       on_2b + 
                       on_3b +
                       outs +
                       p_score +
                       b_score,
                     data=pitcher_train,
                     control = rpart.control(cp = .005, minsplit = 30))

prune_1se = function(my_tree) {
  out = as.data.frame(my_tree$cptable)
  thresh = min(out$xerror + out$xstd)
  cp_opt = max(out$CP[out$xerror <= thresh])
  prune(my_tree, cp=cp_opt)
}

pitcher.tree_prune = prune_1se(pitcher.tree)

## Plot

rpart.plot(pitcher.tree_prune, type=4, extra=1)


```

Hernandez is a pitcher with a diverse arsenal of pitches. As one can see, the predictive model analyzes factors about the game situation to indicate the next pitch. It considers, for example, the count on the batter and whether the batter stands left or right. After running through the branches and nodes with binary decisions based on the in-game situation, a prediction about the next pitch is made at the bottom of the tree. The random forest takes a bootstrap aggregate of trees like this one, but a single tree helps us see an example of the predictive process. 

#### The Lagged Model

The second random forest builds upon the features selected in the Situational Model and supplements them with information about the previous two pitches and the event the last at-bat. This allows for the model to incorporate lagged information that might directly influence the next pitch. Did the pitcher just give up a home run on the curve? Maybe it's a steady diet of fastballs from here on out. Did the pitcher just give the batter two straight fastballs to study? Perhaps it's time for an off-speed pitch like a change-up. 

#### Trash Can Model

The third and final random forest uses nearly every feature from the dataset to control for all possible scenarios and variations in the feature matrix. This means that it not only considers all the factors included in the other two models, but also includes what the pitcher's game has looked like so far; that is, it takes into account the pitch choices as a percent of the overall pitches in the game up to that point. (Is this a correct reading?) So if the pitcher is leaning heavily on the slider that day, this model will incorporate that pattern. 

## Results

In [TABLE/APPENDIX], we publish our models' results for 30 pitchers from Major League Baseball. These pitchers are generally considered some of the best in the business, but there are some pitchers from outside the top tier for completeness. We also note that the model is easily adaptable to any pitcher who threw between 2015 and 2018. In [TABLE/APPENDIX], we present the pitching profiles of the 30 pitchers based on the style of their pitches and the frequency that they are thrown.  

To measure our models' effectiveness, we compare them to the most-common pitch thrown by the pitcher (called "sitONE") and to each other. The out-of-sample performance of each model is presented in "trashcans" 1 to 3 (our sincerest apologies to Astros fans for the name). 

Most models improved on the guess of the upcoming pitch when compared to the "sitting on the pitch" as seen in [TABLE/APPENDIX]. Consider the case of Chris Sale. Sale is a perennial All-Star, and finished top-5 in Cy Young (MLB's most valuable pitcher award) votes each year of our data. If a batter were to look for his most common pitch (the two-seam fastball), he would would only be right about one third of the time. However, Sale becomes increasingly more predictable as the model incorporates more features. The Situational Model and the Lagged Model predict his next pitch at 37% and 38% respectively. Still, the Game Fixed Effects Model predicts his next pitch with an out-of-sample accuracy of nearly 46%, a jump of about 13%. There isn't a hitter in baseball who wouldn't want to know Sale's next pitch with a 13% increase in accuracy!

(Do these numbers need to be responsive to different train/test splits?)
I think it'd be nice, but I think it counts as unfeasible for our computing power purposes since running the models once takes me about 30 minutes for me at least. But for interpretation purposes, small difference in performance might not be stable results so they shouldn't be read into too much. 

On the other hand, some pitcher profiles grew in accuracy only up through the first or second model, and then decrease as more features are added. For example, Mark Melancon and Huston Street have out-of-sample prediction accuracies that peak in the Lagged Model but fall in the Game Fixed Effects Model. We present this as some evidence of over-fitting for certain pitchers. 

Not all pitchers are particularly predictable, however. Corey Kluber, a two-time Cy Young winner (one time in our data window), has such a varied arsenal of pitches that even the most predictive model (.343 out of sample accuracy) barely little information about the next pitch, even if it beats he sit-one rate. Further, some pitchers remained elusive for all three of the models. Trevor Rosenthal, for instance, throws a fastball on 75% of his pitches, and all three models performed worse than this "sitting on the pitch" rate. [Do we have a good reason for why this might be happening?]


Finally, we note that predictive power does not necessarily equate to hits. Enter Zack Britton, who led the league in saves during the 2016 season. Britton is nearly a one-pitch pitcher, throwing sinkers on 89.7% of his pitches. The Game Fixed Effects model improves this prediction a few fractions of a percent, but in either case, it's fair to say that most hitters know exactly what Britton is about to throw. Nevertheless, Britton put up an otherworldly 0.54 ERA in 2016! That is to say, even if batters knew with near perfect clairvoyance a that sinker was on its way, making contact that leads to a hit is a whole other matter. 

## what it all means, probably nothing 

implications for how hitters should approach thinking about predicting pitches. 
What it all means: 
- we've demonstrated that the game situation, previous pitches, previous result, batting order position, and game to game changes in a pitcher's "stuff" all help predict pitches
- for some pitcher, all of these features are helpful. for others, using all of the features over fits
- this modelling is not dierrctly useful to teams on a pitch to pitch level. it'd probably be considered cheating for an assistant coach to be sitting in the dugout with laptop inputting the situation and having the model spit back predictions. Baseball has already shown it is uncomfortable with certain levels of technology entering the game, adding machine learning would be overstepping no doubt. 
- rather, what we've provided is a framework for hitters to analyze what kind of information is helpful in predicting a particular pitcher's pitch type. They can focus on the information that is important and ignore the rest. this will help them in building scouting reports on pitchers
- as the Astros showed us all in 2017?, this is crucial

(gonna try to make this coherent)
Moreover: 
- where our work might be useful on a pitch to pitch basis is with fan enjoyment experience. baseball has lost popularity in recent years, with Tv ratings on the decline and game attendance faltering as well. Surely, this decrease is due to the games slow pace and lack of entertainment value for the casual fan. after all, the game grinds to a halt after each pitch, pausing for players and coaches to relay signs, adjust equipment, and mentally prepare for the next pitch

but for baseball enthusiasts, this segmented gameplay is part of the fun. After each pitch, it is perfectly observable to all players involved what the situation is. The "game within the game" is figuring out how to best respond to each state of the game. And a big part of that is the batter trying to guess what pitch is coming and the pitcher trying to throw a pitch that the batter might not expect. 

our modeling tool can be a tool to let fans watching at home in on the game within the game, which is why we've built our shiny web app. Our app allows a fan to input a situation and get pitch prediction percentages in return. This will vastly improve porch beers with the boys while listening to America's past time on the radio as well as Friday Night baseball on the couch with Dom's

## Appendix
```{r tables, include=TRUE}
overall_performance_all

types_Trevor_Rosenthal
types_Felix_Hernandez
types_Chris_Archer
types_Zach_Britton
types_Wade_Davis
types_Dallas_Keuchel
types_Corey_Kluber
types_Luke_Gregerson
types_David_Price
types_Max_Scherzer
types_Aroldis_Chapman
types_Clayton_Kershaw
types_Madison_Bumgarner
types_Sonny_Gray
types_Huston_Street
types_Brad_Boxberger
types_Zack_Greinke
types_Shawn_Tolleson
types_Jordan_Zimmermann
types_Jacob_deGrom
types_Gerrit_Cole
types_Mark_Melancon
types_Jake_Arrieta
types_Andrew_Miller
types_Stephen_Strasburg
types_Collin_McHugh
types_Michael_Wacha
types_Chris_Sale
types_Zack_Greinke
types_Yu_Darvish

by_pitch_performance_Trevor_Rosenthal
by_pitch_performance_Felix_Hernandez
by_pitch_performance_Chris_Archer
by_pitch_performance_Zach_Britton
by_pitch_performance_Wade_Davis
by_pitch_performance_Dallas_Keuchel
by_pitch_performance_Corey_Kluber
by_pitch_performance_Luke_Gregerson
by_pitch_performance_David_Price
by_pitch_performance_Max_Scherzer
by_pitch_performance_Aroldis_Chapman
by_pitch_performance_Clayton_Kershaw
by_pitch_performance_Madison_Bumgarner
by_pitch_performance_Sonny_Gray
by_pitch_performance_Huston_Street
by_pitch_performance_Brad_Boxberger
by_pitch_performance_Zack_Greinke
by_pitch_performance_Shawn_Tolleson
by_pitch_performance_Jordan_Zimmermann
by_pitch_performance_Jacob_deGrom
by_pitch_performance_Gerrit_Cole
by_pitch_performance_Mark_Melancon
by_pitch_performance_Jake_Arrieta
by_pitch_performance_Andrew_Miller
by_pitch_performance_Stephen_Strasburg
by_pitch_performance_Collin_McHugh
by_pitch_performance_Michael_Wacha
by_pitch_performance_Chris_Sale
by_pitch_performance_Zack_Greinke
by_pitch_performance_Yu_Darvish

```