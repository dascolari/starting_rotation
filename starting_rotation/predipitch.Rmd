---
title: "Predi-Pitch: Snack on This Curve Whenever You Want"
author: "David Scolari, Harrison Snell, Brandon Williams"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(here)
path <- here()

source(file.path(path, 'code', 'dugout.R'))

load(file = file.path(path, 'output', 'tables', "overall_performance_all.RDs"))


foreach(id = 1:30) %do% {
  # make filenames according to loop index
  fname_type <- paste0("types", id, ".RDs")
  fname_zones <- paste0("zones", id, ".RDs")
  fname_bypitch <- paste0("by_pitch_performance", id, ".RDs")

  # load table outputs according to loop index
  load(file = file.path(path, 'output', 'tables', fname_type))
  load(file = file.path(path, 'output', 'tables', fname_zones))
  load(file = file.path(path, 'output', 'tables', fname_bypitch))
  }
```

## Introduction
Gentlemen, pitch predicting is a very important part of baseball. So important that teams will do almost anything for insight on what the opposing team's pitcher is going to throw. Other than illicit methods, hitters are trained to use information on a pitcher's previous pitch throwing behvior to guess which pitch is coming next. We can model this deciscion making process with machine learning techniques. 

By modeling pitch prediction, we can learn what information is relevant to a pitcher's pitch selection. We can also better understand what makes a pitcher more unpredictable than other. It's gonna be good

In the following report will talk about why pithes are different, share evidence that pitchers have different strategies from at bat to at bat, and describe the engineering of our model, which is basically a trashcan .

## Pitches are different you dumb dumb idiot

Harrison's graphs


## The Data

The data involved in this project consists of every pitch from the 2015 through the 2018 Major League Baseball (MLB) seasons. These four seasons contained nearly 3 million observations, and the data include categorization of 16 different types of pitches, the spin, speed, and location of each pitch, the game situation (score, runners on base, balls and strikes, etc.), information about the pitcher and batter, and the result of the at-bat. 

To this already rich data set, we add a few important features. Since each pitch is identified by an atbat id and a pitch number, we can add the previous pitch types as features to each pitch. For this model, we add categorical features for the previous two pitches. We also add the previous atbat's result as a feature.

Although information on each batter might be helpful for this modeling problem, as pitchers might have a specialized approach to facing each batter, we did not have easy access to this kind of player data. As an alternative, we add a factor variable indicating the position in the batting order the pitcher is facing. A team's best hitter tend to bat 3rd or 4th in the order, and a team's worst hitter tend to bat 8th and 9th, so batting order may be able to tell our model a lot about what pitch types a pitcher will throw. 

Lastly, we add features for the game specific share of pitches that each of a pitcher's pitch types make up. This set of features is meant to capture the fact that what a pitcher has in his arsenal may change from game to game. Most games a pitcher might throw mostly four seam fastballs, but there might be "game specific fixed effects" that lead him to rely more on his secondary pitches. We'd like our model to be able to use this information in making its predictions.

## Methodology

(David, supplement these descriptions with further details as needed.)

Given how difficult it is to get hits consistently at the major league level, having an idea an idea of what the opposing pitcher is about to throw would confer a significant advantage to the hitter. We endeavor to create a model that successfully predicts the next pitch a pitcher will throw in an at-bat, given the circumstances of the at-bat, the tendencies of the pitcher, and the progress of the game up to that point. Using three distinct random forest models, we derive a predictive approach that generally outperforms guessing that the pitcher will throw their most common pitch (often called "sitting on a pitch"), and in most cases, significantly exceeds this "sitting on a pitch" approach.

### Background on Random Forest Models

Random forests, much like actual forests, are an aggregation of individual trees. The below figure is a dendrogram, a graphical representation of a tree model that classifies [PITCHER X]'s pitch type. 

[DENDROGRAM]

The dendrogram intuitively depicts how tree models make predictions: through a series of binary decisions based on a selection of features that sort the data into groups of most likely outcomes.

While trees are intuitive, a well performing model will add some layers of complexity that reduce over fitting. Bootstrap aggregating, or "bagging" involves taking $B$ bootstrapped samples of the original data and fitting a tree model to each one. Predictions are generated using a summary of the $B$ tree models. For a categorical outcome, each tree model contributes one vote and the outcome is classified by majority rule. 

Random forests extend bagged trees by only allowing each individual tree to use $m$ of the total number of features, $p$. So bagging is equivalent to a random forest with $m = p$. Restricting the each tree to a subset of the total features decorrelates the individual tree models, reducing variance in the predictions and making it less likely that the model will over fit the data. For our random forest models, we use a common choice of feature size, $m \approx \sqrt p$.

#### The Situational Model

The first of our three random forest models uses information readily available in the at-bat to predict the upcoming pitch. The features involved here include the ball-strike count, opposing batter's stance, inning, how many pitches thrown in the at-bat so far, the game score, and the runners on base.

#### The Lagged Model

The second random forest builds upon the features selected in the Situational Model and supplements them with information about the previous two pitches and the event the last at-bat. This allows for the model to incorporate lagged information that might directly influence the next pitch. Did the pitcher just give up a home run on the curve? Maybe it's a steady diet of fastballs from here on out. Did the pitcher just give the batter two straight fastballs to study? Perhaps it's time for an off-speed pitch like a change-up. 

#### Game-Level Fixed Effects Model

The third and final random forest uses nearly every feature from the dataset to control for all possible scenarios and variations in the feature matrix. This means that it not only considers all the factors included in the other two models, but also includes what the pitcher's game has looked like so far; that is, it takes into account the pitch choices as a percent of the overall pitches in the game up to that point. (Is this a correct reading?) So if the pitcher is leaning heavily on the slider that day, this model will incorporate that pattern. 

## Results

Most models improved on the guess of the upcoming pitch when compared to the "sitting on the pitch" (called "sitONE") as seen in [TABLE/APPENDIX]. Consider the case of Chris Sale. Sale is a perennial All-Star, and finished top-5 in Cy Young (MLB's most valuable pitcher award) votes each year of our data. If a batter were to look for his most common pitch (the two-seam fastball), he would would only be right about one third of the time. However, Sale becomes increasingly more predictable as the model incorporates more features. The Situational Model and the Lagged Model predict his next pitch at 37% and 38% respectively. Still, the Game Fixed Effects Model predicts his next pitch with an out-of-sample accuracy of nearly 46%, a jump of about 13%. There isn't a hitter in baseball who wouldn't want to know Sale's next pitch with a 13% increase in accuracy!

(Do these numbers need to be responsive to different train/test splits?)
I think it'd be nice, but I think it counts as unfeasible for our computing power purposes since running the models once takes me about 30 minutes for me at least. But for interpretation purposes, small difference in performance might not be stable results so they shouldn't be read into too much. 

Predictive power does not necessarily equate to hits. Enter Zack Britton, who led the league in saves during the 2016 season. Britton is nearly a one-pitch pitcher, throwing sinkers on 89.7% of his pitches. The Game Fixed Effects model improves this prediction a few fractions of a percent, but in either case, it's fair to say that most hitters know what Britton is about to throw. Nevertheless, Britton put up an otherworldly 0.54 ERA in 2016! Even if batters knew that sinker was on its way, making contact that leads to a hit is a whole other matter. 


## what it all means, probably nothing 

What it all means: 
- we've demonstrated that the game situation, previous pitches, previous result, batting order position, and game to game changes in a pitcher's "stuff" all help predict pitches
- for some pitcher, all of these features are helpful. for others, using all of the features over fits
- this modelling is not dierrctly useful to teams on a pitch to pitch level. it'd probably be considered cheating for an assistant coach to be sitting in the dugout with laptop inputting the situation and having the model spit back predictions. Baseball has already shown it is uncomfortable with certain levels of technology entering the game, adding machine learning would be overstepping no doubt. 
- rather, what we've provided is a framework for hitters to analyze what kind of information is helpful in predicting a particular pitcher's pitch type. They can focus on the information that is important and ignore the rest. this will help them in building scouting reports on pitchers
- as the Astros showed us all in 2017?, this is crucial

(gonna try to make this coherent)
Moreover: 
- where our work might be useful on a pitch to pitch basis is with fan enjoyment experience. baseball has lost popularity in recent years, with Tv ratings on the decline and game attendance faltering as well. Surely, this decrease is due to the games slow pace and lack of entertainment value for the casual fan. after all, the game grinds to a halt after each pitch, pausing for players and coaches to relay signs, adjust equipment, and mentally prepare for the next pitch

but for baseball enthusiasts, this segmented gameplay is part of the fun. After each pitch, it is perfectly observable to all players involved what the situation is. The "game within the game" is figuring out how to best respond to each state of the game. And a big part of that is the batter trying to guess what pitch is coming and the pitcher trying to throw a pitch that the batter might not expect. 

our modeling tool can be a tool to let fans watching at home in on the game within the game, which is why we've built our shiny web app. Our app allows a fan to input a situation and get pitch prediction percentages in return. This will vastly improve porch beers with the boys while listening to America's past time on the radio as well as Friday Night baseball on the couch with Dom's

## Appendix
```{r tables, include=TRUE}
overall_performance_all

types_Trevor_Rosenthal
types_Felix_Hernandez
types_Chris_Archer
types_Zach_Britton
types_Wade_Davis
types_Dallas_Keuchel
types_Corey_Kluber
types_Luke_Gregerson
types_David_Price
types_Max_Scherzer
types_Aroldis_Chapman
types_Clayton_Kershaw
types_Madison_Bumgarner
types_Sonny_Gray
types_Huston_Street
types_Brad_Boxberger
types_Zack_Greinke
types_Shawn_Tolleson
types_Jordan_Zimmermann
types_Jacob_deGrom
types_Gerrit_Cole
types_Mark_Melancon
types_Jake_Arrieta
types_Andrew_Miller
types_Stephen_Strasburg
types_Collin_McHugh
types_Michael_Wacha
types_Chris_Sale
types_Zack_Greinke
types_Yu_Darvish

by_pitch_performance_Trevor_Rosenthal
by_pitch_performance_Felix_Hernandez
by_pitch_performance_Chris_Archer
by_pitch_performance_Zach_Britton
by_pitch_performance_Wade_Davis
by_pitch_performance_Dallas_Keuchel
by_pitch_performance_Corey_Kluber
by_pitch_performance_Luke_Gregerson
by_pitch_performance_David_Price
by_pitch_performance_Max_Scherzer
by_pitch_performance_Aroldis_Chapman
by_pitch_performance_Clayton_Kershaw
by_pitch_performance_Madison_Bumgarner
by_pitch_performance_Sonny_Gray
by_pitch_performance_Huston_Street
by_pitch_performance_Brad_Boxberger
by_pitch_performance_Zack_Greinke
by_pitch_performance_Shawn_Tolleson
by_pitch_performance_Jordan_Zimmermann
by_pitch_performance_Jacob_deGrom
by_pitch_performance_Gerrit_Cole
by_pitch_performance_Mark_Melancon
by_pitch_performance_Jake_Arrieta
by_pitch_performance_Andrew_Miller
by_pitch_performance_Stephen_Strasburg
by_pitch_performance_Collin_McHugh
by_pitch_performance_Michael_Wacha
by_pitch_performance_Chris_Sale
by_pitch_performance_Zack_Greinke
by_pitch_performance_Yu_Darvish

```